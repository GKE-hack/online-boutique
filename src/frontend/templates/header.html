<!--
 Copyright 2020 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

{{ define "header" }}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, shrink-to-fit=no"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>
      {{ if $.is_cymbal_brand }} Cymbal Shops {{ else }} Online Boutique {{ end
      }}
    </title>
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB"
      crossorigin="anonymous"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Google+Symbols:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ $.baseUrl }}/static/styles/styles.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ $.baseUrl }}/static/styles/cart.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ $.baseUrl }}/static/styles/order.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ $.baseUrl }}/static/styles/bot.css"
    />
    {{ if $.is_cymbal_brand }}
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="{{ $.baseUrl }}/static/favicon-cymbal.ico"
    />
    {{ else }}
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="{{ $.baseUrl }}/static/favicon.ico"
    />
    {{ end }}

    <style>
      .notifications-container {
        position: relative;
        display: inline-block;
        margin-right: 15px;
      }

      .notifications-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 300px;
        max-width: 400px;
        z-index: 1000;
        margin-top: 5px;
      }

      .notifications-header {
        padding: 15px 20px 10px;
        border-bottom: 1px solid #eee;
        background-color: #f8f9fa;
        border-radius: 8px 8px 0 0;
      }

      .notifications-header h4 {
        margin: 0;
        font-size: 16px;
        color: #333;
        font-weight: 600;
      }

      .notifications-list {
        max-height: 400px;
        overflow-y: auto;
      }

      .notification-item {
        padding: 15px 20px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .notification-item:hover {
        background-color: #f8f9fa;
      }

      .notification-item:last-child {
        border-bottom: none;
        border-radius: 0 0 8px 8px;
      }

      .notification-item.unread {
        background-color: #e3f2fd;
        border-left: 4px solid #2196f3;
      }

      .notification-content {
        font-size: 14px;
        color: #333;
        line-height: 1.4;
        margin-bottom: 5px;
      }

      .notification-time {
        font-size: 12px;
        color: #888;
      }

      .no-notifications {
        color: #888;
        font-style: italic;
        text-align: center;
      }

      .cart-size-circle {
        background-color: #ff6b6b;
        color: white;
        border-radius: 50%;
        font-size: 12px;
        font-weight: bold;
        position: absolute;
        top: -8px;
        right: -8px;
        min-width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 4px;
      }

      .notifications-container .cart-link {
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        justify-content: center !important;
        margin-left: 25px;
        position: relative;
        height: 60px;
      }

      .notifications-container .cart-link svg {
        margin-bottom: 3px;
      }
    </style>
  </head>

  <body>
    <header>
      {{ if $.frontendMessage }}
      <div class="navbar">
        <div class="container d-flex justify-content-center">
          <div class="h-free-shipping">{{ $.frontendMessage }}</div>
        </div>
      </div>
      {{ end }}
      <div class="navbar sub-navbar">
        <div class="container d-flex justify-content-between">
          <a
            href="{{ $.baseUrl }}/"
            class="navbar-brand d-flex align-items-center"
          >
            {{ if $.is_cymbal_brand }}
            <img
              src="{{ $.baseUrl }}/static/icons/Cymbal_NavLogo.svg"
              alt=""
              class="top-left-logo-cymbal"
            />
            {{ else }}
            <img
              src="{{ $.baseUrl }}/static/icons/Hipster_NavLogo.svg"
              alt=""
              class="top-left-logo"
            />
            {{ end }}
          </a>
          <div class="controls">
            {{ if $.show_currency }}
            <div class="h-controls">
              <div class="h-control">
                <span class="icon currency-icon">
                  {{ renderCurrencyLogo $.user_currency}}</span
                >
                <form
                  method="POST"
                  class="controls-form"
                  action="{{ $.baseUrl }}/setCurrency"
                  id="currency_form"
                >
                  <select
                    name="currency_code"
                    onchange="document.getElementById('currency_form').submit();"
                  >
                    {{range $.currencies}}
                    <option
                      value="{{.}}"
                      {{if
                      eq
                      .
                      $.user_currency}}selected="selected"
                      {{end}}
                    >
                      {{.}}
                    </option>
                    {{end}}
                  </select>
                </form>
                <img
                  src="{{ $.baseUrl }}/static/icons/Hipster_DownArrow.svg"
                  alt=""
                  class="icon arrow"
                />
              </div>
            </div>
            {{ end }} {{ if $.assistant_enabled }}
            <a href="{{ $.baseUrl }}/assistant" class="cart-link">
              <img
                src="{{ $.baseUrl }}/static/icons/Hipster_WandIcon.svg"
                style="width: 22px; height: 22px"
                alt="Assistant icon"
                class="logo"
                title="Assistant"
              />
            </a>
            {{ end }}

            <!-- Notifications -->
            <div class="notifications-container">
              <button
                id="notifications-toggle"
                class="cart-link"
                style="
                  background: none;
                  border: none;
                  padding: 0;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                "
              >
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  style="color: #666"
                  title="Notifications"
                >
                  <path
                    d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"
                    fill="currentColor"
                  />
                </svg>
                <span
                  id="notifications-badge"
                  class="cart-size-circle"
                  style="display: none"
                  >0</span
                >
              </button>
              <div
                id="notifications-dropdown"
                class="notifications-dropdown"
                style="display: none"
              >
                <div class="notifications-header">
                  <h4>AI Assistant Suggestions</h4>
                </div>
                <div id="notifications-list" class="notifications-list">
                  <div class="notification-item no-notifications">
                    No new suggestions yet
                  </div>
                </div>
              </div>
            </div>

            <a href="{{ $.baseUrl }}/cart" class="cart-link">
              <img
                src="{{ $.baseUrl }}/static/icons/Hipster_CartIcon.svg"
                alt="Cart icon"
                class="logo"
                title="Cart"
              />
              {{ if $.cart_size }}
              <span class="cart-size-circle">{{$.cart_size}}</span>
              {{ end }}
            </a>
            {{ if .IsAuthenticatedAdmin }}
            <a href="{{ $.baseUrl }}/admin/generate-ads" class="cart-link">
              <span style="font-size: 22px; color: #666" title="Admin AdGen"
                >ðŸŽ¬</span
              >
            </a>
            {{ end }}
          </div>
        </div>
      </div>
    </header>

    <script>
      // Notification system JavaScript
      class NotificationManager {
        constructor() {
          this.notifications = [];
          this.isDropdownOpen = false;
          this.initializeElements();
          this.bindEvents();
          this.loadNotifications();
          this.startPolling();
        }

        initializeElements() {
          this.toggleButton = document.getElementById("notifications-toggle");
          this.dropdown = document.getElementById("notifications-dropdown");
          this.badge = document.getElementById("notifications-badge");
          this.list = document.getElementById("notifications-list");
        }

        bindEvents() {
          // Toggle dropdown
          this.toggleButton.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            this.toggleDropdown();
          });

          // Close dropdown when clicking outside
          document.addEventListener("click", (e) => {
            if (!e.target.closest(".notifications-container")) {
              this.closeDropdown();
            }
          });
        }

        toggleDropdown() {
          this.isDropdownOpen = !this.isDropdownOpen;
          this.dropdown.style.display = this.isDropdownOpen ? "block" : "none";
        }

        closeDropdown() {
          this.isDropdownOpen = false;
          this.dropdown.style.display = "none";
        }

        async loadNotifications() {
          try {
            const response = await fetch("/api/notifications");
            if (response.ok) {
              this.notifications = await response.json();
              this.renderNotifications();
              this.updateBadge();
            }
          } catch (error) {
            console.error("Failed to load notifications:", error);
          }
        }

        renderNotifications() {
          if (this.notifications.length === 0) {
            this.list.innerHTML =
              '<div class="notification-item no-notifications">No new suggestions yet</div>';
            return;
          }

          this.list.innerHTML = this.notifications
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
            .map((notification) => this.renderNotification(notification))
            .join("");

          // Bind click events to notification items
          this.list.querySelectorAll(".notification-item").forEach((item) => {
            item.addEventListener("click", (e) => {
              const notificationId = e.currentTarget.dataset.notificationId;
              if (notificationId) {
                this.markAsRead(notificationId);
              }
            });
          });
        }

        renderNotification(notification) {
          const timeAgo = this.getTimeAgo(new Date(notification.timestamp));
          const unreadClass = notification.read ? "" : "unread";

          return `
                    <div class="notification-item ${unreadClass}" data-notification-id="${
            notification.id
          }">
                        <div class="notification-content">${this.escapeHtml(
                          notification.message
                        )}</div>
                        <div class="notification-time">${timeAgo}</div>
                    </div>
                `;
        }

        async markAsRead(notificationId) {
          try {
            const response = await fetch(
              `/api/notifications/${notificationId}/read`,
              {
                method: "POST",
              }
            );
            if (response.ok) {
              // Update local state
              const notification = this.notifications.find(
                (n) => n.id === notificationId
              );
              if (notification) {
                notification.read = true;
                this.renderNotifications();
                this.updateBadge();
              }
            }
          } catch (error) {
            console.error("Failed to mark notification as read:", error);
          }
        }

        updateBadge() {
          const unreadCount = this.notifications.filter((n) => !n.read).length;
          if (unreadCount > 0) {
            this.badge.textContent = unreadCount;
            this.badge.style.display = "flex";
          } else {
            this.badge.style.display = "none";
          }
        }

        getTimeAgo(date) {
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMins / 60);
          const diffDays = Math.floor(diffHours / 24);

          if (diffMins < 1) return "Just now";
          if (diffMins < 60) return `${diffMins}m ago`;
          if (diffHours < 24) return `${diffHours}h ago`;
          return `${diffDays}d ago`;
        }

        escapeHtml(text) {
          const div = document.createElement("div");
          div.textContent = text;
          return div.innerHTML;
        }

        startPolling() {
          // Poll for new notifications every 30 seconds
          setInterval(() => {
            this.loadNotifications();
          }, 30000);
        }
      }

      // Initialize notifications when DOM is ready
      document.addEventListener("DOMContentLoaded", () => {
        new NotificationManager();
      });
    </script>

    {{end}}
  </body>
</html>
